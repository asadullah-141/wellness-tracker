{% extends 'WellnessApp/base.html' %}
{% block content %}

<h4 class="mb-4">Welcome {{ user.userprofile.full_name|default:user.username }}</h4>

<!-- Title & Date Search -->
<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
  <h4 class="mb-0">Your Recent Logs</h4>

  <form method="get" class="d-flex align-items-center gap-2">
    <input type="text" name="date" value="{{ search_date }}" placeholder="YYYY-MM-DD"
           class="form-control form-control-sm" style="width: 150px;">
    <button type="submit" class="btn btn-sm btn-outline-secondary">Search</button>
    {% if search_date %}
      <a href="{% url 'dashboard' %}" class="btn btn-sm btn-outline-secondary">Reset</a>
    {% endif %}
  </form>

  <a href="{% url 'add_log' %}" class="btn btn-outline-dark">+ Add Log</a>
</div>

<!-- Logs Table -->
<div class="card shadow-sm">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Water (L)</th>
            <th>Exercise</th>
            <th>Sleep (hrs)</th>
            <th>Mood</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for log in logs %}
            <tr>
              <td>{{ log.date }}</td>
              <td><span class="badge bg-secondary">{{ log.water_intake_ml }}L</span></td>
              <td>{{ log.exercise_type }} <small class="text-muted">({{ log.exercise_duration }} min)</small></td>
              <td>{{ log.sleep_hours }}</td>
              <td><span class="badge bg-light text-dark">{{ log.mood }}</span></td>
              <td>
                <a href="{% url 'edit_log' log.id %}" class="btn btn-sm btn-outline-secondary">Edit</a>
                <a href="{% url 'delete_log' log.id %}" class="btn btn-sm btn-outline-danger">Delete</a>
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="6" class="text-center text-muted">No logs yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Pagination -->
{% if logs.has_other_pages %}
<nav class="mt-3">
  <ul class="pagination justify-content-center">
    {% if logs.has_previous %}
      <li class="page-item"><a class="page-link" href="?{% if search_date %}date={{ search_date }}&{% endif %}page={{ logs.previous_page_number }}">&laquo;</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
    {% endif %}

    {% for num in logs.paginator.page_range %}
      {% if logs.number == num %}
        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
      {% else %}
        <li class="page-item"><a class="page-link" href="?{% if search_date %}date={{ search_date }}&{% endif %}page={{ num }}">{{ num }}</a></li>
      {% endif %}
    {% endfor %}

    {% if logs.has_next %}
      <li class="page-item"><a class="page-link" href="?{% if search_date %}date={{ search_date }}&{% endif %}page={{ logs.next_page_number }}">&raquo;</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
    {% endif %}
  </ul>
</nav>
{% endif %}

<!-- Charts -->
<h4 class="mt-5">7-Day Wellness Trends</h4>
<div class="row">
  <div class="col-md-6 mb-4"><canvas id="waterChart"></canvas></div>
  <div class="col-md-6 mb-4"><canvas id="sleepChart"></canvas></div>
  <div class="col-md-6 mb-4"><canvas id="exerciseChart"></canvas></div>
  <div class="col-md-6 mb-4"><canvas id="moodChart"></canvas></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const labels = [{% for log in chart_data %}"{{ log.date }}",{% endfor %}];
const waterData = [{% for log in chart_data %}{{ log.water_intake_ml|default:0 }},{% endfor %}];
const sleepData = [{% for log in chart_data %}{{ log.sleep_hours|default:0 }},{% endfor %}];
const exerciseData = [{% for log in chart_data %}{{ log.exercise_duration|default:0 }},{% endfor %}];
const moodData = [{% for log in chart_data %}"{{ log.mood|default:'Neutral' }}",{% endfor %}];
const moodScores = { 'Happy': 3, 'Neutral': 2, 'Sad': 1, '': 2 };
const moodTrend = moodData.map(m => moodScores[m] || 2);

const makeChart = (id, label, data, color, bg) => {
  new Chart(document.getElementById(id), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: label,
        data: data,
        borderColor: color,
        backgroundColor: bg,
        tension: 0.3
      }]
    }
  });
};

makeChart('waterChart', 'Water Intake (ml)', waterData, 'blue', 'lightblue');
makeChart('sleepChart', 'Sleep Hours', sleepData, 'green', 'lightgreen');
makeChart('exerciseChart', 'Exercise Duration (min)', exerciseData, 'orange', 'peachpuff');

new Chart(document.getElementById('moodChart'), {
  type: 'line',
  data: {
    labels: labels,
    datasets: [{
      label: 'Mood Trend',
      data: moodTrend,
      borderColor: 'purple',
      backgroundColor: 'lavender',
      tension: 0.3
    }]
  },
  options: {
    scales: {
      y: {
        ticks: {
          callback: value => ['Sad', 'Neutral', 'Happy'][value - 1],
          stepSize: 1,
          min: 1,
          max: 3
        }
      }
    }
  }
});
</script>
{% endblock %}
